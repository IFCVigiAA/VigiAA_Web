<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Dinâmico - Leaflet & GeoServer</title>

    <!-- Leaflet CSS (pode ficar no head) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    
    <style>
        /* 1. Reset e Fix de Tela Cheia */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%; /* Use 100% para evitar rolagem extra em mobile */
            overflow: hidden; /* **ESSENCIAL** para remover a rolagem da página */
        }

        /* 2. Container do Mapa (Ocupando 100% da tela) */
        #mapid { 
            height: 100%; /* Mantenha 100% para se basear no body fixo */
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
        }

        /* 3. Estilos Base das Legendas (POSIÇÃO VERTICAL SERÁ CONTROLADA PELO JS) */
        .map-legend {
            box-sizing: border-box; /* Boa prática! */
            position: fixed; /* Mantenha FIXED para flutuar sobre a viewport */
            bottom:10vh;
            left: 2vw;
            max-width: 90vw;
            z-index: 9999;
            font-size: 14px;
            background-color: white;
            border: 2px solid grey;
            padding: 10px;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
            overflow-x: auto;
            word-wrap: break-word;
            border-radius: 8px;
        }

        /* 4. Estilos dos Ícones da Legenda */
        .map-legend i {
            display: block;
            width: 18px;
            height: 10px;
            float: left;
            margin-right: 8px;
            border: 1px solid #ccc;
            border-radius: 2px;
        }
        
        /* 5. Estilo para o Botão Toggle Leaflet */
        .leaflet-control-toggle-button {
            background-color: white;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            text-decoration: none;
            color: #333;
            cursor: pointer;
            border-radius: 5px;
            border-bottom: 1px solid #ccc;
        }
        
        /* 6. Media Query para Celular (Ajustes de tamanho e rolagem interna) */
        @media (max-width: 768px) {
            /* Ajustes de Legenda */
            .map-legend {
                bottom:15vh;
                left: 1vw; 
                max-width: 48vw; 
                font-size: 10px; 
                padding: 5px; 
            }
            
            /* Ajustes de Ícones */
            .map-legend i {
                width: 12px;
                height: 8px;
                margin-right: 5px;
            }

            /* Controle de Camadas (Rolagem interna) */
            .leaflet-control-layers {
                font-size: 10px; 
                max-height: 45vw !important; /* Aumentado um pouco para ser menos apertado */
                overflow-y: hidden !important; /* **MANTENHA ISSO!** Cria a barra de rolagem interna */
                box-sizing: border-box;
            }

            /* Aplicar scroll apenas na lista */
            .leaflet-control-layers-list {
                max-height: 15vh;        /* limite de altura no celular */
                overflow-y: auto;        /* barra interna de rolagem */
                -webkit-overflow-scrolling: touch; /* rolagem suave no iOS */
            }
        }
    </style>
</head>
<body>
    <div id="mapid"></div>

    <!-- Legenda de Declividade -->
    <div class="map-legend" style=" display: none;" id="declividade-legend">
        <b>Declividade (m)</b><br>
        <i style="background:#238b45;"></i> 0 - 100<br>
        <i style="background:#41ab5d;"></i> 100 - 200<br>
        <i style="background:#74c476;"></i> 200 - 300<br>
        <i style="background:#a1d99b;"></i> 300 - 400<br>
        <i style="background:#ECF74A;"></i> 400 - 500<br>
        <i style="background:#F54927;"></i> 500 - 600<br>
        <i style="background:#FF0000;"></i> 600 - 700<br>
        <i style="background:#b30000;"></i> 700 - 800<br>
        <i style="background:#cccccc;"></i> &gt; 800<br>
        <div style="clear:both;"></div>
    </div>

    <!-- Legenda de Demografia -->
    <div class="map-legend" style=" display: none;" id="demografia_ofc-legend">
        <b>Densidade Demográfica</b><br>
        <div>(Setores Censitários)</div><br>
        <i style="background:#238b45;"></i> 164 - 1985<br>
        <i style="background:#41ab5d;"></i> 2010 - 3550<br>
        <i style="background:#74c476;"></i> 3618 - 5329<br>
        <i style="background:#a1d99b;"></i> 5331 - 6804<br>
        <i style="background:#ECF74A;"></i> 7203 - 8609<br>
        <i style="background:#F54927;"></i> 8142 - 10258<br>
        <i style="background:#FF0000;"></i> 10431 - 12879<br>
        <i style="background:#b30000;"></i> 13219 - 16165<br>
        <div style="clear:both;"></div>
    </div>


    <!-- Legenda de Demografia -->
    <div class="map-legend" style=" display: none;" id="demografia-legend">
        <b>Demografia 2022 (%)</b><br>
        <i style="background:#fce5cd;"></i> &le; 16,75<br>
        <i style="background:#f9cb9c;"></i> 16,75 - 33,40<br>
        <i style="background:#f6b26b;"></i> 33,40 - 50,05<br>
        <i style="background:#e69138;"></i> 50,05 - 66,70<br>
        <i style="background:#cc0000;"></i> 66,70 - 83,35<br>
        <i style="background:#990000;"></i> &gt; 83,35<br>
        <div style="clear:both;"></div>
    </div>

    <!-- Legenda do Mapa de Calor (inicialmente oculta, visibilidade controlada por JS) -->
    <div class="map-legend" style=" display: none;" id="heatmap-legend">
        <b>Casos Positivos (Mapa de Calor)</b><br>
        <p style="margin: 5px 0;">Áreas mais escuras indicam maior concentração de casos.</p>
        <div style="width: 100%; height: 20px; background: linear-gradient(to right, blue, cyan, lime, yellow, red); border-radius: 4px;"></div>
        <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 5px;">
            <span>Baixa concentração</span>
            <span>Alta concentração</span>
        </div>
    </div>
    

    
    <!-- 3. Seu Script Customizado (Depende de ambos os anteriores) -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <!-- <script src="https://unpkg.com/leaflet.label@0.2.1/dist/leaflet.label.js"></script> -->

    <script>

        // --- Sua função principal (window.onload) ---
        window.onload = function() {
            // --- 1. Configuração Inicial do Mapa ---
            var map = L.map('mapid').setView([-27.0258, -48.6549], 12);

            // Adiciona uma camada base (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // --- 2. Variáveis para Armazenar as Camadas ---
            var bairrosWFSLayer;
            var bairrosOfcWFSLayer;
            var setCensWFSLayer;
            var camboriuWFSLayer;
            var curvasNivelWFSLayer;
            var cnCambPLWFSLayer;
            var setCensDemoCambLayer;
            var focosWFSLayer;
            var peWFSLayer;
            var armWFSLayer;
            var currentCasosPointLayer; 
            var currentCasosHeatmapLayer;
            var declividadeImageLayer;
            var demografiaImageLayer;

            // --- Variáveis para o Controle de Camadas ---
            var baseLayers = {}; 
            var overlayMaps = {}; 

            // --- Função Auxiliar para Gerenciar a Atualização de Camadas no Controle ---
            function refreshLayerInControl(oldLayer, newLayer, layerName) {
                const wasOnMap = oldLayer && map.hasLayer(oldLayer);
                if (wasOnMap) {
                    map.removeLayer(oldLayer); 
                }

                if (map.layersControl && oldLayer) {
                    map.layersControl.removeLayer(oldLayer);
                }
                
                if (map.layersControl) {
                    map.layersControl.addOverlay(newLayer, layerName);
                }

                if (wasOnMap) {
                    newLayer.addTo(map);
                }
            }

            // --- Função Genérica para buscar e adicionar Camadas WFS (para GeoJSON) ---
            function fetchWFSData(layerName, displayName, styleFunction, popupFields, version = '2.0.0', isPointLayer = false) {
                var wfsUrl = `http://192.168.70.63:8080/geoserver/wfs?`;
                var params = {
                    service: 'WFS',
                    version: version,
                    request: 'GetFeature',
                    typeName: layerName,
                    outputFormat: 'application/json'
                };
                var queryString = new URLSearchParams(params).toString();
                var fullUrl = wfsUrl + queryString;

                console.log(`Buscando dados WFS para: ${displayName} (${fullUrl})`);

                return fetch(fullUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} for ${displayName}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Dados para ${displayName} recebidos.`);

                        var layerOptions = {
                            style: styleFunction,
                            onEachFeature: function(feature, layer) {
                                if (feature.properties) {
                                    var popupContent = `<b>${displayName.split('(')[0].trim()}:</b><br>`;
                                    var fieldsToDisplay = popupFields && popupFields.length > 0 ? popupFields : Object.keys(feature.properties);
                                    for (var field of fieldsToDisplay) {
                                        if (feature.properties[field] !== undefined) {
                                            let alias = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                            popupContent += `<b>${alias}:</b> ${feature.properties[field]}<br>`;
                                        }
                                    }
                                    layer.bindPopup(popupContent);
                                }
                            }
                        };

                        if (isPointLayer) {
                            layerOptions.pointToLayer = function(feature, latlng) {
                                return L.circleMarker(latlng, styleFunction(feature));
                            };
                        }

                        var newLayer = L.geoJSON(data, layerOptions);
                        newLayer.name = displayName;
                        return newLayer;
                    }).catch(error => {
                        console.error(`Erro ao buscar ou processar dados WFS para ${displayName}:`, error);
                        return null;
                    });
            }

            // --- 4. Definição dos Estilos para Camadas GeoJSON ---
            var bairrosStyleWFS = function(feature) { return { fillColor: '#add8e6', color: 'black', weight: 1, fillOpacity: 0.5 }; };
            var bairrosOfcStyleWFS = function(feature) { return { fillColor: '#89d1fa', color: 'black', weight: 1, fillOpacity: 0.5 }; };
            var setCensStyleWFS = function(feature) { return { fillColor: '#f07b73', color: 'black', weight: 1, fillOpacity: 0.5 }; };
            var densDemoSetCensStyle = function (feature) {
                const classe = feature.properties.Classe;
                let fillColor;
                switch (classe) {
                    case 1: fillColor = '#238b45'; break;
                    case 2: fillColor = '#41ab5d'; break;
                    case 3: fillColor = '#74c476'; break;
                    case 4: fillColor = '#a1d99b'; break;
                    case 5: fillColor = '#ECF74A'; break;
                    case 6: fillColor = '#F54927'; break;
                    case 7: fillColor = '#FF0000'; break;
                    case 8: fillColor = '#b30000'; break;
                }
                return { fillColor: fillColor, color: 'black', weight: 0.5, fillOpacity: 1 };
            };
            var declividadePlStyle = function (feature) {
                const classe = feature.properties.CLASSE;
                let fillColor;
                switch (classe) {
                    case '0 - 100m': fillColor = '#238b45'; break;
                    case '100 - 200m': fillColor = '#41ab5d'; break;
                    case '200 - 300m': fillColor = '#74c476'; break;
                    case '300 - 400m': fillColor = '#a1d99b'; break;
                    case '400 - 500m': fillColor = '#ECF74A'; break;
                    case '500 - 600m': fillColor = '#F54927'; break;
                    case '600 - 700m': fillColor = '#FF0000'; break;
                    case '700 - 800m': fillColor = '#b30000'; break;
                    default: fillColor = '#cccccc';
                }
                return { fillColor: fillColor, color: 'black', weight: 0.5, fillOpacity: 1 };
            };
            var curvasNivelStyleWFS = function (feature) { return { color: "#faf605", weight: 2, opacity: 1.0 }; };
            var casosPointStyleWFS = function(feature) { return { radius: 5, fillColor: 'red', color: '#000', weight: 1, opacity: 1, fillOpacity: 0.7 }; };
            var camboriuStyleWFS = function(feature) { return { fillColor: '#ffcc00', color: 'black', weight: 1, fillOpacity: 0.5 }; };
            var focosStyleWFS = function(feature) { return { radius: 5, fillColor: 'orange', color: '#000', weight: 1, opacity: 1, fillOpacity: 0.7 }; };
            var peStyleWFS = function(feature) { return { radius: 5, fillColor: 'green', color: '#000', weight: 1, opacity: 1, fillOpacity: 0.7 }; };
            var armStyleWFS = function(feature) { return { radius: 5, fillColor: 'purple', color: '#000', weight: 1, opacity: 1, fillOpacity: 0.7 }; };

            // --- 5. Funções de Carga e Atualização (WFS e Imagem) ---
            function loadBairrosOnce() { return fetchWFSData('vigiaa_ofc:vw_bairros_cb_ofc', 'Bairros - Oficial (Estático)', bairrosStyleWFS, ['nome']); }
            function loadBairrosOfcOnce() { return fetchWFSData('vigiaa_ofc:vw_bairros_cb_ibge', 'Bairros - IBGE (Estático)', bairrosOfcStyleWFS, ['NM_BAIRRO']); }
            function loadSetCensOnce() { return fetchWFSData('vigiaa_ofc:vw_set_cens_camb', 'Setores Censitários (Estático)', setCensStyleWFS, ['NM_BAIRRO']); }
            function loadDeclividadePoligonoOnce() { return fetchWFSData('vigiaa_ofc:vw_cv_nvl_camboriu_union', 'Declividade (Polígonos)', declividadePlStyle, ['CLASSE', 'AREA_METROS']); }
            function loadDensDemoSetCensOnce() { return fetchWFSData('vigiaa_ofc:vw_set_cens_demo_camb_classes', 'Densidade Demográfica (SC)', densDemoSetCensStyle, ['DENSIDADE_DEMOGRAFICA_SETOR_HAB_KM2']); }
            function loadCamboriuOnce() { return fetchWFSData('vigiaa_ofc:vw_mun_camb', 'Camboriú (Estático)', camboriuStyleWFS, ['NM_MUN']); }
            function loadCurvaNivelOnce() { return fetchWFSData('vigiaa_ofc:vw_cv_nvl_camboriu_li', 'Curva de Nível (Estático)', curvasNivelStyleWFS, ['CLASSE']); } 
            function updadeFocosAedes() {
                return fetchWFSData('vigiaa:focos_aedes_1604_com_coords', 'Focos Aedes (Dinâmico)', focosStyleWFS, ['id', 'Nº Foco'], '2.0.0', true).then(newLayer => {
                    if (newLayer) { refreshLayerInControl(focosWFSLayer, newLayer, 'Focos Aedes (Dinâmico)'); focosWFSLayer = newLayer; }
                    return focosWFSLayer;
                });
            }
            function updatePontosEstrat() {
                return fetchWFSData('vigiaa:pontos_estrategicos', 'Pontos Estratégicos (Dinâmico)', peStyleWFS, ['id', 'numero'], '2.0.0', true).then(newLayer => {
                    if (newLayer) { refreshLayerInControl(peWFSLayer, newLayer, 'Pontos Estratégicos (Dinâmico)'); peWFSLayer = newLayer; }
                    return peWFSLayer;
                });
            }
            function updateArmadilhas() {
                return fetchWFSData('vigiaa:relat_arm', 'Armadilhas (Dinâmico)', armStyleWFS, ['id', 'numero'], '2.0.0', true).then(newLayer => {
                    if (newLayer) { refreshLayerInControl(armWFSLayer, newLayer, 'Armadilhas (Dinâmico)'); armWFSLayer = newLayer; }
                    return armWFSLayer;
                });
            }
            function updateCasosPositivosPoints() {
                return fetchWFSData('vigiaa:casos_positivos', 'Casos Positivos (Pontos)', casosPointStyleWFS, ['id', 'data_diagnostico'], '2.0.0', true).then(newLayer => {
                    if (newLayer) { refreshLayerInControl(currentCasosPointLayer, newLayer, 'Casos Positivos (Pontos)'); currentCasosPointLayer = newLayer; }
                    return currentCasosPointLayer;
                });
            }
            function updateCasosHeatmap() {
                const wfsUrl = `http://192.168.70.63:8080/geoserver/wfs?`;
                const params = { service: 'WFS', version: '2.0.0', request: 'GetFeature', typeName: 'vigiaa:casos_positivos', outputFormat: 'application/json' };
                const queryString = new URLSearchParams(params).toString();
                const fullUrl = wfsUrl + queryString;
                console.log(`Buscando dados WFS para Casos Positivos (Heatmap): ${fullUrl}`);
                return fetch(fullUrl)
                    .then(response => {
                        if (!response.ok) { throw new Error(`HTTP error! status: ${response.status} for Casos Positivos (Heatmap)`); }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Dados para Casos Positivos (Heatmap) recebidos.`);
                        var heatData = [];
                        if (data && data.features) {
                            data.features.forEach(feature => {
                                if (feature.geometry && feature.geometry.coordinates) {
                                    var coords = feature.geometry.coordinates; 
                                    heatData.push([coords[1], coords[0]]);
                                }
                            });
                        }
                        var newHeatmapLayer = L.heatLayer(heatData, { radius: 25, blur: 15, maxZoom: 17, minOpacity: 0.2, gradient: { 0.0: 'blue', 0.25: 'cyan', 0.5: 'lime', 0.75: 'yellow', 1.0: 'red' } });
                        refreshLayerInControl(currentCasosHeatmapLayer, newHeatmapLayer, 'Casos Positivos (Mapa de Calor)');
                        currentCasosHeatmapLayer = newHeatmapLayer;
                        return currentCasosHeatmapLayer;
                    })
                    .catch(error => { console.error(`Erro ao buscar ou processar dados para Casos Positivos (Heatmap):`, error); return null; });
            }
            
            function loadImageLayers() {
                const declividadeBounds = [[-27.196900051, -48.88833825645294], [-26.951489787, -48.53321516854706]]; 
                const demografiaBounds = [[-27.145871184999997, -48.75972971313529], [-26.95321603, -48.493185639864706]]; 

                const declividadeImageUrl = "mapa_declividade_transparente.png"; 
                const demografiaImageUrl = "mapa_dens_transparente.png";

                declividadeImageLayer = L.imageOverlay(declividadeImageUrl, declividadeBounds, { opacity: 1.0, interactive: true, alt: 'Mapa de Declividade' });
                declividadeImageLayer.name = 'Declividade (Imagem)'; 

                demografiaImageLayer = L.imageOverlay(demografiaImageUrl, demografiaBounds, { opacity: 1.0, interactive: true, alt: 'Mapa de Demografia' });
                demografiaImageLayer.name = 'Demografia (Imagem)'; 

                return Promise.resolve([declividadeImageLayer, demografiaImageLayer]);
            }

            // --- 6. Inicialização das Camadas e do Controle de Camadas ---
            Promise.all([
                loadBairrosOnce(),
                loadBairrosOfcOnce(),
                loadSetCensOnce(),
                loadCamboriuOnce(),
                loadCurvaNivelOnce(),
                updadeFocosAedes(),
                updatePontosEstrat(),
                updateArmadilhas(),
                updateCasosPositivosPoints(),
                updateCasosHeatmap(),
                loadImageLayers(),
                loadDeclividadePoligonoOnce(),
                loadDensDemoSetCensOnce()
            ]).then(results => {
                const [
                    bairrosLayerResult,
                    bairrosOfcLayerResult,
                    setCensLayerResult,
                    camboriuLayerResult,
                    curvaNivelLayerResult, 
                    focosLayerResult, 
                    peLayerResult, 
                    armLayerResult,
                    casosPointLayerResult,
                    casosHeatmapLayerResult,
                    imageLayersResults,
                    declividadePlResult,
                    densDemoSetCensResult
                ] = results;

                const [declividadeImgLayer, demografiaImgLayer] = imageLayersResults;

                if (bairrosLayerResult) { overlayMaps['Bairros - Oficial (Estático)'] = bairrosLayerResult; }
                if (bairrosOfcLayerResult) { overlayMaps['Bairros - IBGE (Estático)'] = bairrosOfcLayerResult; }
                if (setCensLayerResult) { overlayMaps['Setores Censitários (Estático)'] = setCensLayerResult; }
                if (curvaNivelLayerResult) { overlayMaps['Curva de Nível (Estático)'] = curvaNivelLayerResult; }
                if (declividadePlResult) { overlayMaps['Declividade (Polígonos)'] = declividadePlResult; }
                if (densDemoSetCensResult){ overlayMaps['Densidade Demográfica (SC)'] = densDemoSetCensResult; }
                if (camboriuLayerResult) { overlayMaps['Camboriú (Estático)'] = camboriuLayerResult; }
                if (focosLayerResult) { overlayMaps['Focos Aedes (Dinâmico)'] = focosLayerResult; }
                if (peLayerResult) { overlayMaps['Pontos Estratégicos (Dinâmico)'] = peLayerResult; }
                if (armLayerResult) { overlayMaps['Armadilhas (Dinâmico)'] = armLayerResult; }
                if (casosPointLayerResult) { overlayMaps['Casos Positivos (Pontos)'] = casosPointLayerResult; }
                if (casosHeatmapLayerResult) { overlayMaps['Casos Positivos (Mapa de Calor)'] = casosHeatmapLayerResult; }
                if (declividadeImgLayer) { overlayMaps['Declividade (Imagem)'] = declividadeImgLayer; declividadeImageLayer = declividadeImgLayer; }
                if (demografiaImgLayer) { overlayMaps['Demografia (Imagem)'] = demografiaImgLayer; demografiaImageLayer = demografiaImgLayer; }

                map.layersControl = L.control.layers(baseLayers, overlayMaps, { collapsed: false }).addTo(map);

                map.on('overlayadd', function (e) {
                    if (e.name === 'Casos Positivos (Mapa de Calor)') { document.getElementById('heatmap-legend').style.display = 'block'; }
                    if (e.name === 'Declividade (Polígonos)') { document.getElementById('declividade-legend').style.display = 'block'; }
                    if (e.name === 'Densidade Demográfica (SC)') { document.getElementById('demografia_ofc-legend').style.display = 'block'; }
                });

                map.on('overlayremove', function (e) {
                    if (e.name === 'Casos Positivos (Mapa de Calor)') { document.getElementById('heatmap-legend').style.display = 'none'; }
                    if (e.name === 'Declividade (Polígonos)') { document.getElementById('declividade-legend').style.display = 'none'; }
                    if (e.name === 'Densidade Demográfica (SC)') { document.getElementById('demografia_ofc-legend').style.display = 'none'; }
                });

                setInterval(updateCasosPositivosPoints, 300000); 
                setInterval(updateCasosHeatmap, 300000);
                setInterval(updadeFocosAedes, 300000);
                setInterval(updatePontosEstrat, 300000);
                setInterval(updateArmadilhas, 300000);

                console.log("Controle de camadas adicionado. Verifique o mapa e o console para mais informações.");
            }).catch(error => {
                console.error("Erro fatal na inicialização das camadas. Alguma camada inicial não pôde ser carregada:", error);
            });
        }; 
    </script>
</body>
</html> 